{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'questionpapers/css/paper_list.css' %}">

<div class="layout">
  <!-- Glass Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h3>Subjects</h3>
      {% if user.is_staff %}
      <a href="{% url 'questionpapers:paper_create' %}" class="upload-btn">
        <i class="bi bi-upload"></i> Upload
      </a>
      {% endif %}
    </div>

    <ul class="subject-list">
      {% for subject in papers_by_subject.keys %}
      <li class="subject-item" data-subject="{{ subject }}">{{ subject }}</li>
      {% endfor %}
    </ul>

    <!-- Sidebar Filter Section (Dynamic) -->
    <div class="sidebar-filters hidden">
      <h4>Filter Options</h4>
      <input type="text" id="searchInput" placeholder="Search paper title...">
      <select id="levelFilter">
        <option value="">All Levels</option>
        <option value="SL">Standard Level (SL)</option>
        <option value="HL">Higher Level (HL)</option>
      </select>
      <select id="paperFilter">
        <option value="">All Papers</option>
        <option value="1">Paper 1</option>
        <option value="2">Paper 2</option>
        <option value="3">Paper 3</option>
      </select>
    </div>
  </aside>

  <!-- Main Section -->
  <main class="main-content">
    <div class="main-inner">
      {% for subject, papers_group in papers_by_subject.items %}
      <div class="papers-group" data-subject="{{ subject }}" style="display:none;">
        {% for p in papers_group %}
        <div class="paper-card">
          <div class="card-content">
            <h5>{{ p.title }}</h5>
            <p>Level: {{ p.level }}</p>
            <p>Paper: Paper {{ p.paper_number }}</p>
            <p>Type: {{ p.paper_type|title }}</p>
            <p>Duration: {{ p.duration_minutes }} mins</p>
          </div>

          <div class="card-actions">
            <a class="btn view-btn" href="{% url 'questionpapers:paper_detail' p.pk %}">
              <i class="bi bi-eye"></i> View
            </a>

            {% if not user.is_staff and p.is_published %}
            <a class="btn appear-btn" href="{% url 'questionpapers:start_paper' p.pk %}">
              <i class="bi bi-pencil-square"></i> Appear
            </a>
            {% endif %}

            {% if user.is_staff %}
            <a class="btn btn-sm" href="{% url 'questionpapers:upload_questions' p.id %}">
              <i class="bi bi-question-circle"></i> Upload Qs
            </a>
            <a class="btn btn-sm" href="{% url 'questionpapers:paper_update' p.pk %}">
              <i class="bi bi-pencil"></i> Edit
            </a>
            <form method="post" action="{% url 'questionpapers:paper_delete' p.pk %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm"
                onclick="return confirm('Are you sure you want to delete this paper?');">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% endfor %}
    </div>
  </main>
</div>

<script>
const subjectItems = document.querySelectorAll('.subject-item');
const papersGroups = document.querySelectorAll('.papers-group');
const sidebarFilters = document.querySelector('.sidebar-filters');
const searchInput = document.getElementById('searchInput');
const levelFilter = document.getElementById('levelFilter');
const paperFilter = document.getElementById('paperFilter');
let activeGroup = null;

subjectItems.forEach(item => {
  item.addEventListener('click', () => {
    subjectItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    const subject = item.dataset.subject;

    papersGroups.forEach(g => g.style.display = 'none');
    const selected = document.querySelector(`.papers-group[data-subject="${subject}"]`);

    if (selected) {
      selected.style.display = 'flex';
      sidebarFilters.classList.remove('hidden');
      activeGroup = selected;
      filterPapers();
      document.querySelector('.main-content').scrollIntoView({ behavior: "smooth" });
    }
  });
});

function filterPapers() {
  if (!activeGroup) return;
  const sVal = searchInput.value.toLowerCase();
  const lVal = levelFilter.value;
  const pVal = paperFilter.value;

  activeGroup.querySelectorAll('.paper-card').forEach(card => {
    const title = card.querySelector('h5').textContent.toLowerCase();
    const level = card.querySelector('p:nth-of-type(1)').textContent;
    const paper = card.querySelector('p:nth-of-type(2)').textContent;

    const match = title.includes(sVal)
      && (lVal === "" || level.includes(lVal))
      && (pVal === "" || paper.includes("Paper " + pVal));

    card.style.display = match ? "block" : "none";
  });
}

searchInput.addEventListener('input', filterPapers);
levelFilter.addEventListener('change', filterPapers);
paperFilter.addEventListener('change', filterPapers);
</script>
{% endblock %}
